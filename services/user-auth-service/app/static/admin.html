<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-ERP User Management Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="adminApp()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">M-ERP User Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" x-text="'Logged in as: ' + currentUser.email"></span>
                    <button @click="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Login Form (shown when not authenticated) -->
    <div x-show="!isAuthenticated" x-cloak x-transition class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Admin Login
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Please sign in with your admin credentials
                </p>
            </div>
            <form class="mt-8 space-y-6" @submit.prevent="login()">
                <div>
                    <label for="email" class="sr-only">Email address</label>
                    <input x-model="loginForm.email" id="email" name="email" type="email" required
                           class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="Email address">
                </div>
                <div>
                    <label for="password" class="sr-only">Password</label>
                    <input x-model="loginForm.password" id="password" name="password" type="password" required
                           class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                           placeholder="Password">
                </div>
                <div>
                    <button type="submit" :disabled="loading"
                            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                        <span x-show="!loading">Sign in</span>
                        <span x-show="loading">Signing in...</span>
                    </button>
                </div>
                <div x-show="loginError" x-cloak class="rounded-md bg-red-50 p-4">
                    <div class="text-sm text-red-700" x-text="loginError"></div>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content (shown when authenticated) -->
    <div x-show="isAuthenticated" x-cloak x-transition class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8">
                <button @click="activeTab = 'users'" 
                        :class="activeTab === 'users' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    Users
                </button>
                <button @click="activeTab = 'roles'" 
                        :class="activeTab === 'roles' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    Roles
                </button>
            </nav>
        </div>

        <!-- Users Tab -->
        <div x-show="activeTab === 'users'" x-cloak>
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="sm:flex sm:items-center mb-6">
                        <div class="sm:flex-auto">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">User Management</h3>
                            <p class="mt-2 text-sm text-gray-700">Manage user accounts and role assignments.</p>
                        </div>
                        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                            <button @click="openCreateUserModal()" 
                                    class="inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:w-auto">
                                Create User
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="mb-4">
                        <input x-model="userSearch" @input="searchUsers()" 
                               placeholder="Search users by email or name..."
                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>

                    <!-- Users Table -->
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roles</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="user in users" :key="user.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                                        <span class="text-sm font-medium text-gray-700 uppercase" x-text="user.first_name[0] + user.last_name[0]"></span>
                                                    </div>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900" x-text="user.first_name + ' ' + user.last_name"></div>
                                                    <div class="text-sm text-gray-500" x-text="user.email"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex flex-wrap gap-1">
                                                <template x-for="role in user.roles" :key="role">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" x-text="role"></span>
                                                </template>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                                  class="inline-flex px-2 py-1 text-xs font-semibold rounded-full">
                                                <span x-text="user.is_active ? 'Active' : 'Inactive'"></span>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span x-text="formatDate(user.created_at)"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button @click="editUser(user)" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                                            <button @click="toggleUserStatus(user)" 
                                                    :class="user.is_active ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'"
                                                    class="mr-3"
                                                    x-text="user.is_active ? 'Deactivate' : 'Activate'">
                                            </button>
                                            <button x-show="user.email !== currentUser.email" @click="deleteUser(user)" 
                                                    class="text-red-600 hover:text-red-900">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="users.length === 0">
                                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                        No users found
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div x-show="userPagination.total_pages > 1" class="mt-4 flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Showing <span x-text="((userPagination.page - 1) * userPagination.per_page) + 1"></span> to 
                            <span x-text="Math.min(userPagination.page * userPagination.per_page, userPagination.total)"></span> of 
                            <span x-text="userPagination.total"></span> users
                        </div>
                        <div class="flex space-x-2">
                            <button @click="loadUsers(userPagination.page - 1)" :disabled="userPagination.page <= 1"
                                    class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <button @click="loadUsers(userPagination.page + 1)" :disabled="userPagination.page >= userPagination.total_pages"
                                    class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roles Tab -->
        <div x-show="activeTab === 'roles'" x-cloak>
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="sm:flex sm:items-center mb-6">
                        <div class="sm:flex-auto">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Role Management</h3>
                            <p class="mt-2 text-sm text-gray-700">Manage system roles and their permissions.</p>
                        </div>
                        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                            <button @click="openCreateRoleModal()" 
                                    class="inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:w-auto">
                                Create Role
                            </button>
                        </div>
                    </div>

                    <!-- Roles Table -->
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Users</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permissions</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="role in roles" :key="role.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900" x-text="role.name"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-900" x-text="role.description || 'No description'"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900" x-text="role.user_count + ' users'"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-500" x-text="role.permissions.length + ' permissions'"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button @click="editRole(role)" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                                            <button x-show="!['superuser', 'admin', 'user', 'readonly'].includes(role.name)" 
                                                    @click="deleteRole(role)" 
                                                    class="text-red-600 hover:text-red-900">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="roles.length === 0">
                                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                        No roles found
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <div x-show="message" x-cloak 
         :class="messageType === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'"
         class="fixed top-4 right-4 p-4 rounded-md border z-50">
        <div class="flex">
            <div class="ml-3">
                <p class="text-sm font-medium" x-text="message"></p>
            </div>
            <div class="ml-auto pl-3">
                <button @click="message = ''" class="inline-flex text-gray-400 hover:text-gray-600">
                    <span class="sr-only">Dismiss</span>
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div x-show="showCreateUserModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New User</h3>
                
                <!-- Error notification for Create User Modal -->
                <div x-show="createUserError" x-cloak 
                     class="mb-4 p-4 rounded-md bg-red-50 border border-red-200">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-800" x-text="createUserError"></p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button @click="createUserError = ''" class="inline-flex text-red-400 hover:text-red-600">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input x-model="createUserForm.email" type="email" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">First Name</label>
                        <input x-model="createUserForm.first_name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Last Name</label>
                        <input x-model="createUserForm.last_name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Password</label>
                        <input x-model="createUserForm.password" type="password" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <p class="mt-1 text-xs text-gray-500">Minimum 8 characters with letters, numbers, and symbols</p>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="createUserForm.is_active" 
                                   class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700">Active Account</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Assign Roles</label>
                        <div class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                            <template x-for="role in availableRoles" :key="role.id">
                                <label class="flex items-center">
                                    <input type="checkbox" :value="role.name" x-model="createUserForm.role_names" 
                                           class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700" x-text="role.name + ' - ' + (role.description || 'No description')"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="cancelCreateUser()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        Cancel
                    </button>
                    <button @click="createUser()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md">
                        Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div x-show="showEditUserModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Edit User</h3>
                
                <!-- Error notification for Edit User Modal -->
                <div x-show="editUserError" x-cloak 
                     class="mb-4 p-4 rounded-md bg-red-50 border border-red-200">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-800" x-text="editUserError"></p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button @click="editUserError = ''" class="inline-flex text-red-400 hover:text-red-600">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input x-model="editUserForm.email" disabled class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">First Name</label>
                        <input x-model="editUserForm.first_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Last Name</label>
                        <input x-model="editUserForm.last_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Roles</label>
                        <div class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                            <template x-for="role in availableRoles" :key="role.id">
                                <label class="flex items-center">
                                    <input type="checkbox" :value="role.name" x-model="editUserForm.roles" 
                                           class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700" x-text="role.name + ' - ' + (role.description || 'No description')"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showEditUserModal = false" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        Cancel
                    </button>
                    <button @click="updateUser()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Role Modal -->
    <div x-show="showCreateRoleModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Role</h3>
                
                <!-- Error notification for Create Role Modal -->
                <div x-show="createRoleError" x-cloak 
                     class="mb-4 p-4 rounded-md bg-red-50 border border-red-200">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-800" x-text="createRoleError"></p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button @click="createRoleError = ''" class="inline-flex text-red-400 hover:text-red-600">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role Name</label>
                        <input x-model="createRoleForm.name" required placeholder="e.g., custom_manager"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <p class="mt-1 text-xs text-gray-500">Use lowercase with underscores (e.g., sales_assistant)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea x-model="createRoleForm.description" rows="2" placeholder="Brief description of this role's purpose"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Permissions</label>
                        <div class="space-y-3 max-h-80 overflow-y-auto border rounded-md p-3">
                            <template x-for="(permissions, category) in availablePermissions.categories" :key="category">
                                <div class="border-b border-gray-100 pb-2 mb-2 last:border-b-0">
                                    <h4 class="font-medium text-sm text-gray-800 mb-2" x-text="category"></h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        <template x-for="permission in permissions" :key="permission">
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" :value="permission" x-model="createRoleForm.permissions" 
                                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                                <span class="ml-2 text-gray-700" x-text="permission"></span>
                                            </label>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Select permissions that users with this role should have</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="cancelCreateRole()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        Cancel
                    </button>
                    <button @click="createRole()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md">
                        Create Role
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Role Modal -->
    <div x-show="showEditRoleModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Role</h3>
                
                <!-- Error notification for Edit Role Modal -->
                <div x-show="editRoleError" x-cloak 
                     class="mb-4 p-4 rounded-md bg-red-50 border border-red-200">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-800" x-text="editRoleError"></p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button @click="editRoleError = ''" class="inline-flex text-red-400 hover:text-red-600">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role Name</label>
                        <input x-model="editRoleForm.name" disabled 
                               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm sm:text-sm">
                        <p class="mt-1 text-xs text-gray-500">Role name cannot be changed</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea x-model="editRoleForm.description" rows="2" 
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Permissions</label>
                        <div class="space-y-3 max-h-80 overflow-y-auto border rounded-md p-3">
                            <template x-for="(permissions, category) in availablePermissions.categories" :key="category">
                                <div class="border-b border-gray-100 pb-2 mb-2 last:border-b-0">
                                    <h4 class="font-medium text-sm text-gray-800 mb-2" x-text="category"></h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        <template x-for="permission in permissions" :key="permission">
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" :value="permission" x-model="editRoleForm.permissions" 
                                                       :disabled="['superuser', 'admin'].includes(editRoleForm.name)"
                                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 disabled:opacity-50">
                                                <span class="ml-2 text-gray-700" x-text="permission"></span>
                                            </label>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <p class="mt-2 text-xs text-gray-500" x-show="['superuser', 'admin'].includes(editRoleForm.name)">
                            System roles cannot be modified
                        </p>
                        <p class="mt-2 text-xs text-gray-500" x-show="!['superuser', 'admin'].includes(editRoleForm.name)">
                            Select permissions that users with this role should have
                        </p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showEditRoleModal = false" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        Cancel
                    </button>
                    <button @click="updateRole()" :disabled="['superuser', 'admin'].includes(editRoleForm.name)"
                            class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        function adminApp() {
            return {
                // Authentication state
                isAuthenticated: false,
                currentUser: {},
                accessToken: localStorage.getItem('access_token'),
                
                // UI state
                activeTab: 'users',
                loading: false,
                message: '',
                messageType: 'success',
                
                // Login form
                loginForm: {
                    email: '',
                    password: ''
                },
                loginError: '',
                
                // Data
                users: [],
                roles: [],
                availableRoles: [],
                availablePermissions: { categories: {} },
                
                // Pagination
                userPagination: {
                    page: 1,
                    per_page: 20,
                    total: 0,
                    total_pages: 0
                },
                
                // Search
                userSearch: '',
                
                // Modals
                showEditUserModal: false,
                showCreateUserModal: false,
                showCreateRoleModal: false,
                showEditRoleModal: false,
                
                // Modal error states
                createUserError: '',
                editUserError: '',
                createRoleError: '',
                editRoleError: '',
                
                // Forms
                createUserForm: {
                    email: '',
                    password: '',
                    first_name: '',
                    last_name: '',
                    is_active: true,
                    role_names: []
                },
                editUserForm: {
                    id: null,
                    email: '',
                    first_name: '',
                    last_name: '',
                    roles: []
                },
                createRoleForm: {
                    name: '',
                    description: '',
                    permissions: []
                },
                editRoleForm: {
                    id: null,
                    name: '',
                    description: '',
                    permissions: []
                },
                
                async init() {
                    if (this.accessToken) {
                        await this.validateToken();
                    }
                },
                
                async validateToken() {
                    try {
                        const response = await this.apiRequest('/auth/me', 'GET');
                        this.currentUser = response;
                        
                        // Check if user has admin permissions
                        if (!this.currentUser.permissions || !this.currentUser.permissions.includes('manage_users')) {
                            throw new Error('Admin permissions required');
                        }
                        
                        this.isAuthenticated = true;
                        await this.loadInitialData();
                    } catch (error) {
                        localStorage.removeItem('access_token');
                        this.accessToken = null;
                        this.isAuthenticated = false;
                        console.error('Token validation failed:', error.message);
                    }
                },
                
                async login() {
                    this.loading = true;
                    this.loginError = '';
                    
                    try {
                        const response = await fetch(`${API_BASE}/auth/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.loginForm)
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Login failed');
                        }
                        
                        const data = await response.json();
                        this.accessToken = data.access_token;
                        localStorage.setItem('access_token', data.access_token);
                        this.currentUser = data.user;
                        
                        // Get user permissions from /auth/me endpoint to ensure we have current permissions
                        const userResponse = await this.apiRequest('/auth/me', 'GET');
                        this.currentUser = { ...this.currentUser, permissions: userResponse.permissions };
                        
                        // Check if user has admin permissions
                        if (!this.currentUser.permissions || !this.currentUser.permissions.includes('manage_users')) {
                            throw new Error('Admin permissions required');
                        }
                        
                        // Set authentication state - this will trigger the UI update
                        this.isAuthenticated = true;
                        
                        // Clear login form
                        this.loginForm = { email: '', password: '' };
                        
                        // Use setTimeout to ensure the UI has updated before loading data
                        setTimeout(async () => {
                            try {
                                await this.loadInitialData();
                                this.showMessage('Welcome! Successfully logged in.', 'success');
                            } catch (error) {
                                console.error('Failed to load initial data:', error);
                                this.showMessage('Logged in, but failed to load some data.', 'error');
                            }
                        }, 50);
                        
                    } catch (error) {
                        this.loginError = error.message;
                    } finally {
                        this.loading = false;
                    }
                },
                
                logout() {
                    localStorage.removeItem('access_token');
                    this.accessToken = null;
                    this.isAuthenticated = false;
                    this.currentUser = {};
                    this.users = [];
                    this.roles = [];
                },
                
                async apiRequest(endpoint, method = 'GET', data = null) {
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (this.accessToken) {
                        headers['Authorization'] = `Bearer ${this.accessToken}`;
                    }
                    
                    const config = {
                        method,
                        headers
                    };
                    
                    if (data && method !== 'GET') {
                        config.body = JSON.stringify(data);
                    }
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, config);
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || `Request failed: ${response.status}`);
                    }
                    
                    return response.json();
                },
                
                async loadInitialData() {
                    await Promise.all([
                        this.loadUsers(),
                        this.loadRoles(),
                        this.loadAvailablePermissions()
                    ]);
                },
                
                async loadUsers(page = 1) {
                    try {
                        const params = new URLSearchParams({
                            page: page,
                            per_page: this.userPagination.per_page
                        });
                        
                        if (this.userSearch) {
                            params.append('search', this.userSearch);
                        }
                        
                        const response = await this.apiRequest(`/admin/users?${params}`);
                        this.users = response.users;
                        this.userPagination = {
                            page: response.page,
                            per_page: response.per_page,
                            total: response.total,
                            total_pages: response.total_pages
                        };
                    } catch (error) {
                        this.showMessage(error.message, 'error');
                    }
                },
                
                async loadRoles() {
                    try {
                        const response = await this.apiRequest('/roles/');
                        this.roles = response.roles;
                        this.availableRoles = response.roles;
                    } catch (error) {
                        this.showMessage(error.message, 'error');
                    }
                },
                
                async loadAvailablePermissions() {
                    try {
                        const response = await this.apiRequest('/roles/permissions/available');
                        this.availablePermissions = response;
                    } catch (error) {
                        console.error('Failed to load available permissions:', error);
                    }
                },
                
                searchUsers() {
                    this.loadUsers(1);
                },
                
                // User Management Functions
                cancelCreateUser() {
                    this.createUserForm = {
                        email: '',
                        password: '',
                        first_name: '',
                        last_name: '',
                        is_active: true,
                        role_names: []
                    };
                    this.showCreateUserModal = false;
                },
                
                async createUser() {
                    try {
                        // Clear previous error
                        this.createUserError = '';
                        
                        if (!this.createUserForm.email || !this.createUserForm.password || !this.createUserForm.first_name || !this.createUserForm.last_name) {
                            throw new Error('Please fill in all required fields');
                        }
                        
                        await this.apiRequest('/admin/create-user', 'POST', this.createUserForm);
                        
                        this.cancelCreateUser();
                        await this.loadUsers(this.userPagination.page);
                        this.showMessage('User created successfully', 'success');
                        
                    } catch (error) {
                        this.createUserError = error.message;
                    }
                },
                
                // Modal helper functions
                openCreateUserModal() {
                    this.createUserError = '';
                    this.showCreateUserModal = true;
                },
                
                openCreateRoleModal() {
                    this.createRoleError = '';
                    this.showCreateRoleModal = true;
                },
                
                openEditUserModal(user) {
                    this.editUserError = '';
                    this.editUserForm = {
                        id: user.id,
                        email: user.email,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        roles: [...user.roles]
                    };
                    this.showEditUserModal = true;
                },
                
                openEditRoleModal(role) {
                    this.editRoleError = '';
                    this.editRoleForm = {
                        id: role.id,
                        name: role.name,
                        description: role.description || '',
                        permissions: [...role.permissions]
                    };
                    this.showEditRoleModal = true;
                },
                
                editUser(user) {
                    this.openEditUserModal(user);
                },
                
                async updateUser() {
                    try {
                        // Clear previous error
                        this.editUserError = '';
                        
                        // Update user roles
                        const currentRoles = this.users.find(u => u.id === this.editUserForm.id).roles;
                        
                        // Remove roles that are no longer selected
                        for (const role of currentRoles) {
                            if (!this.editUserForm.roles.includes(role)) {
                                await this.apiRequest('/admin/remove-role', 'POST', {
                                    user_id: this.editUserForm.id,
                                    role_name: role
                                });
                            }
                        }
                        
                        // Add new roles
                        for (const role of this.editUserForm.roles) {
                            if (!currentRoles.includes(role)) {
                                await this.apiRequest('/admin/assign-role', 'POST', {
                                    user_id: this.editUserForm.id,
                                    role_name: role
                                });
                            }
                        }
                        
                        this.showEditUserModal = false;
                        await this.loadUsers(this.userPagination.page);
                        this.showMessage('User updated successfully', 'success');
                        
                    } catch (error) {
                        this.editUserError = error.message;
                    }
                },
                
                async toggleUserStatus(user) {
                    try {
                        await this.apiRequest('/admin/user-status', 'POST', {
                            user_id: user.id,
                            is_active: !user.is_active
                        });
                        
                        await this.loadUsers(this.userPagination.page);
                        this.showMessage(`User ${user.is_active ? 'deactivated' : 'activated'} successfully`, 'success');
                        
                    } catch (error) {
                        this.showMessage(error.message, 'error');
                    }
                },
                
                async deleteUser(user) {
                    // Prevent deleting current user
                    if (user.email === this.currentUser.email) {
                        this.showMessage('Cannot delete your own account', 'error');
                        return;
                    }
                    
                    if (!confirm(`Are you sure you want to delete user "${user.first_name} ${user.last_name}" (${user.email})?\n\nThis action cannot be undone.`)) {
                        return;
                    }
                    
                    try {
                        await this.apiRequest(`/admin/users/${user.id}`, 'DELETE');
                        await this.loadUsers(this.userPagination.page);
                        this.showMessage('User deleted successfully', 'success');
                        
                    } catch (error) {
                        this.showMessage(error.message, 'error');
                    }
                },
                
                // Role Management Functions
                cancelCreateRole() {
                    this.createRoleForm = {
                        name: '',
                        description: '',
                        permissions: []
                    };
                    this.showCreateRoleModal = false;
                },
                
                async createRole() {
                    try {
                        // Clear previous error
                        this.createRoleError = '';
                        
                        if (!this.createRoleForm.name) {
                            throw new Error('Role name is required');
                        }
                        
                        if (this.createRoleForm.permissions.length === 0) {
                            throw new Error('Please select at least one permission');
                        }
                        
                        await this.apiRequest('/roles/', 'POST', this.createRoleForm);
                        
                        this.cancelCreateRole();
                        await this.loadRoles();
                        this.showMessage('Role created successfully', 'success');
                        
                    } catch (error) {
                        this.createRoleError = error.message;
                    }
                },
                
                editRole(role) {
                    this.openEditRoleModal(role);
                },
                
                async updateRole() {
                    try {
                        // Clear previous error
                        this.editRoleError = '';
                        
                        if (this.editRoleForm.permissions.length === 0) {
                            throw new Error('Please select at least one permission');
                        }
                        
                        await this.apiRequest(`/roles/${this.editRoleForm.id}`, 'PUT', {
                            description: this.editRoleForm.description,
                            permissions: this.editRoleForm.permissions
                        });
                        
                        this.showEditRoleModal = false;
                        await this.loadRoles();
                        this.showMessage('Role updated successfully', 'success');
                        
                    } catch (error) {
                        this.editRoleError = error.message;
                    }
                },
                
                async deleteRole(role) {
                    if (!confirm(`Are you sure you want to delete the role "${role.name}"?`)) {
                        return;
                    }
                    
                    try {
                        await this.apiRequest(`/roles/${role.id}`, 'DELETE');
                        await this.loadRoles();
                        this.showMessage('Role deleted successfully', 'success');
                        
                    } catch (error) {
                        this.showMessage(error.message, 'error');
                    }
                },
                
                showMessage(text, type = 'success') {
                    this.message = text;
                    this.messageType = type;
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                },
                
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                }
            };
        }
    </script>
</body>
</html>