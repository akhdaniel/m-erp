# Kong Gateway Configuration for M-ERP Services
_format_version: "3.0"
_transform: true

services:
  # User Authentication Service
  - name: user-auth-service
    url: http://user-auth-service:8000
    tags:
      - m-erp
      - auth
    routes:
      - name: user-auth-routes
        paths:
          - /api/v1/auth
          - /api/auth
          - /api/admin
          - /api/services
          - /api/token
          - /api/audit
          - /api/password
          - /api/users
          - /health
        strip_path: false
        preserve_host: false

  # Company Partner Service  
  - name: company-partner-service
    url: http://company-partner-service:8000
    tags:
      - m-erp
      - business
    routes:
      - name: company-partner-routes
        paths:
          - /api/v1/companies
          - /api/v1/partners
          - /api/v1/currencies
          - /api/companies
          - /api/partners
          - /api/currencies
        strip_path: false
        preserve_host: false
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
      - name: company-partner-health
        paths:
          - /company-health
        strip_path: true
        preserve_host: false

  # Menu Access Service
  - name: menu-access-service
    url: http://menu-access-service:8000
    tags:
      - m-erp
      - access-control
    routes:
      - name: menu-access-routes
        paths:
          - /api/v1/permissions
          - /api/v1/roles
          - /api/v1/menus
        strip_path: false
        preserve_host: false
      - name: menu-access-prefix-routes
        paths:
          - /menu-access
        strip_path: true
        preserve_host: false
      - name: menu-access-health
        paths:
          - /menu-health
        strip_path: true
        preserve_host: false

  # Service Registry
  - name: service-registry
    url: http://service-registry:8000
    tags:
      - m-erp
      - service-discovery
    routes:
      - name: service-registry-routes
        paths:
          - /api/v1/services
          - /api/services
        strip_path: false
        preserve_host: false
        methods: ["GET", "POST", "PUT", "DELETE"]
      - name: service-registry-health
        paths:
          - /registry-health
        strip_path: true
        preserve_host: false

  # Inventory Service
  - name: inventory-service
    url: http://inventory-service:8005
    tags:
      - m-erp
      - inventory
    routes:
      - name: inventory-routes
        paths:
          - /api/v1/inventory
          - /api/v1/products
          - /api/v1/stock
          - /api/v1/warehouses
          - /api/v1/receiving
          - /inventory
        strip_path: false
        preserve_host: false
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
      - name: inventory-health
        paths:
          - /inventory-health
        strip_path: true
        preserve_host: false

  # UI Registry Service
  - name: ui-registry-service
    url: http://ui-registry-service:8010
    tags:
      - m-erp
      - ui-registry
    routes:
      - name: ui-registry-routes
        paths:
          - /api/v1/ui-registry
        strip_path: false
        preserve_host: false
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
      - name: ui-registry-health
        paths:
          - /ui-registry-health
        strip_path: true
        preserve_host: false

  # Sales Service
  - name: sales-service
    url: http://sales-service:8006
    tags:
      - m-erp
      - sales
    routes:
      - name: sales-routes
        paths:
          - /api/v1/sales
          - /api/v1/quotes
          - /api/v1/orders
          - /api/v1/pricing
          - /sales
        strip_path: false
        preserve_host: false
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
      - name: sales-health
        paths:
          - /sales-health
        strip_path: true
        preserve_host: false

plugins:
  # CORS Plugin for browser compatibility
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "http://localhost:3001"
        - "http://localhost:8080"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version  
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 10

  # Rate Limiting (per consumer)
  - name: rate-limiting
    config:
      second: 100
      minute: 1000
      hour: 10000
      policy: local

  # Prometheus metrics
  - name: prometheus
    config:
      per_consumer: true

consumers:
  # Default consumer for development
  - username: m-erp-development
    custom_id: dev-001
    tags:
      - development

  # Service-to-service consumer
  - username: m-erp-services
    custom_id: services-001 
    tags:
      - services